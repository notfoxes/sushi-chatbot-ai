<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JURELL SUSHI - Asistente AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Cormorant+Garamond:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .font-serif { font-family: 'Cormorant Garamond', serif; }
        
        body { 
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #2d2d2d 100%);
            min-height: 100vh;
        }
        
        .gold-gradient {
            background: linear-gradient(135deg, #c9a961 0%, #d4b76f 50%, #b8935c 100%);
        }
        
        .red-gradient {
            background: linear-gradient(135deg, #d94a4a 0%, #e65555 50%, #c73838 100%);
        }
        
        .glass-dark {
            background: rgba(30, 30, 30, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(201, 169, 97, 0.2);
        }
        
        .glass-light {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .chat-bubble { 
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message-user {
            background: linear-gradient(135deg, #d94a4a 0%, #c73838 100%);
            box-shadow: 0 4px 20px rgba(217, 74, 74, 0.3);
        }
        
        .message-bot {
            background: rgba(45, 45, 45, 0.9);
            border: 1px solid rgba(201, 169, 97, 0.3);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }
        
        .btn-gold {
            background: linear-gradient(135deg, #c9a961 0%, #b8935c 100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(201, 169, 97, 0.3);
        }
        
        .btn-gold:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(201, 169, 97, 0.5);
        }
        
        .btn-red {
            background: linear-gradient(135deg, #d94a4a 0%, #c73838 100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(217, 74, 74, 0.3);
        }
        
        .btn-red:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(217, 74, 74, 0.5);
        }
        
        .quick-btn {
            transition: all 0.3s ease;
            border: 1px solid rgba(201, 169, 97, 0.3);
        }
        
        .quick-btn:hover {
            transform: translateY(-3px);
            border-color: rgba(201, 169, 97, 0.6);
            box-shadow: 0 6px 20px rgba(201, 169, 97, 0.2);
        }
        
        .featured-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 3px solid #c9a961;
        }
        
        .featured-card:hover {
            transform: translateX(8px);
            border-left-width: 5px;
            box-shadow: -8px 8px 25px rgba(201, 169, 97, 0.15);
        }
        
        .thinking-dots {
            background: linear-gradient(-45deg, rgba(201, 169, 97, 0.2), rgba(217, 74, 74, 0.2));
            background-size: 400% 400%;
            animation: gradient 2s ease infinite;
        }
        
        @keyframes gradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        input:focus {
            outline: none;
            border-color: #c9a961;
            box-shadow: 0 0 0 3px rgba(201, 169, 97, 0.2);
        }
        
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #c9a961 0%, #b8935c 100%);
            border-radius: 10px;
        }
        
        .logo-container {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .gold-shine {
            position: relative;
            overflow: hidden;
        }
        
        .gold-shine::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }
        
        .gold-shine:hover::before {
            left: 100%;
        }
    </style>
</head>
<body class="text-white">
    
    <!-- Header Premium -->
    <header class="glass-dark border-b border-gold-900/30 sticky top-0 z-50 shadow-2xl">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-6">
                    <!-- Logo -->
                    <div class="logo-container">
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Ccircle cx='100' cy='100' r='90' fill='white'/%3E%3Cpath d='M100 40 Q120 60 140 80 L120 100 Q100 90 80 100 L60 80 Q80 60 100 40Z' fill='%23d94a4a'/%3E%3Cpath d='M40 120 L160 120 M50 110 L150 110 M60 130 L140 130' stroke='%23c9a961' stroke-width='3'/%3E%3C/svg%3E" 
                             alt="JURELL SUSHI" 
                             class="w-16 h-16 rounded-full border-2 border-gold-600 shadow-xl">
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold tracking-wide font-serif text-white">JURELL SUSHI</h1>
                        <p class="text-sm text-gold-500">Asistente Virtual Premium con IA</p>
                    </div>
                    <span class="px-4 py-1.5 rounded-full text-xs font-semibold bg-green-900/30 text-green-400 border border-green-700/50">
                        ‚úì En l√≠nea
                    </span>
                </div>
                <button id="langBtn" class="glass-light text-white px-5 py-2.5 rounded-xl hover:bg-white/10 transition font-medium">
                    üåê ES
                </button>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="max-w-7xl mx-auto px-6 py-8">
        <div class="grid lg:grid-cols-3 gap-8">
            
            <!-- Chat Section -->
            <div class="lg:col-span-2">
                <div class="glass-dark rounded-3xl shadow-2xl overflow-hidden">
                    
                    <!-- Chat Header -->
                    <div class="gold-gradient p-6">
                        <div class="flex items-center space-x-4">
                            <div class="w-14 h-14 bg-black/20 rounded-2xl flex items-center justify-center text-3xl backdrop-blur">
                                ü§ñ
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold text-black font-serif">Asistente Sushi AI</h2>
                                <p class="text-sm text-black/80">Powered by OpenAI GPT-4o-mini</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chat Messages -->
                    <div id="chatMessages" class="h-[500px] overflow-y-auto p-6 space-y-4 bg-gradient-to-b from-black/40 to-black/60">
                        <!-- Messages aparecer√°n aqu√≠ -->
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="p-6 bg-black/40 border-t border-gold-900/30">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-5">
                            <button onclick="quickMessage('Mu√©strame el men√∫ completo')" class="quick-btn glass-light text-white px-4 py-3 rounded-xl text-sm font-semibold hover:bg-white/10">
                                üç± Men√∫
                            </button>
                            <button onclick="quickMessage('Dame tus mejores recomendaciones')" class="quick-btn glass-light text-white px-4 py-3 rounded-xl text-sm font-semibold hover:bg-white/10">
                                ‚≠ê Top 3
                            </button>
                            <button onclick="quickMessage('Opciones sin gluten por favor')" class="quick-btn glass-light text-white px-4 py-3 rounded-xl text-sm font-semibold hover:bg-white/10">
                                üö´ Alergias
                            </button>
                            <button onclick="quickMessage('Cu√°les son los platillos especiales')" class="quick-btn glass-light text-white px-4 py-3 rounded-xl text-sm font-semibold hover:bg-white/10">
                                üåü Especiales
                            </button>
                        </div>
                        
                        <!-- Chat Input -->
                        <div class="flex space-x-3">
                            <input 
                                type="text" 
                                id="chatInput" 
                                class="flex-1 bg-black/50 border-2 border-gold-900/30 rounded-xl px-5 py-3.5 text-white placeholder-gray-500 transition focus:bg-black/70" 
                                placeholder="Pregunta sobre sushi, ingredientes, alergias..."
                                onkeypress="if(event.key==='Enter') sendMessage()"
                            >
                            <button onclick="sendMessage()" class="btn-gold text-black px-8 py-3.5 rounded-xl font-bold">
                                <span class="text-lg">‚û§</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="space-y-6">
                
                <!-- User Profile Card -->
                <div class="glass-dark rounded-2xl shadow-xl p-6">
                    <div id="guestView">
                        <div class="text-center mb-4">
                            <div class="w-16 h-16 bg-gradient-to-br from-gray-600 to-gray-700 rounded-full flex items-center justify-center text-3xl mx-auto mb-3 border-2 border-gold-800/30">
                                üë§
                            </div>
                            <p class="text-gray-300 text-sm mb-1">Modo Invitado</p>
                            <p class="text-xs text-gray-500">Chatbot listo para usar</p>
                        </div>
                        
                        <button onclick="showRegister()" class="w-full gold-shine btn-gold text-black py-3.5 rounded-xl font-bold hover:shadow-xl transition">
                            ‚ú® Guardar mis preferencias
                        </button>
                        
                        <div class="mt-4 p-4 glass-light rounded-xl border border-gold-900/20">
                            <p class="text-xs text-gray-300 leading-relaxed">
                                <strong class="text-gold-500">üí° Beneficios:</strong><br>
                                ‚Ä¢ Recomendaciones personalizadas<br>
                                ‚Ä¢ Historial de pedidos<br>
                                ‚Ä¢ Detecci√≥n de alergias
                            </p>
                        </div>
                    </div>
                    
                    <div id="userView" class="hidden">
                        <div class="text-center mb-4">
                            <div class="w-16 h-16 gold-gradient rounded-full flex items-center justify-center text-3xl mx-auto mb-3 border-2 border-gold-600">
                                üëã
                            </div>
                            <h3 class="font-bold text-white text-lg font-serif" id="userName">Usuario</h3>
                            <p class="text-xs text-gray-400" id="userPhone">Tel√©fono</p>
                            <div class="flex items-center justify-center space-x-2 mt-2">
                                <span class="px-3 py-1 bg-green-900/30 text-green-400 rounded-full text-xs font-semibold border border-green-700/50">‚úì Registrado</span>
                            </div>
                        </div>
                        
                        <div class="space-y-3 mb-4">
                            <div class="flex justify-between items-center p-3 glass-light rounded-xl border border-gold-900/20">
                                <span class="text-sm text-gray-300">üç± Visitas</span>
                                <span class="font-bold text-gold-500" id="userVisits">1</span>
                            </div>
                            <div class="p-3 glass-light rounded-xl border border-gold-900/20">
                                <p class="text-xs text-gray-400 mb-1">‚≠ê Favorito:</p>
                                <p class="text-sm font-semibold text-white" id="userFavorite">A√∫n no tienes</p>
                            </div>
                        </div>
                        
                        <button onclick="logout()" class="w-full bg-gray-700 text-gray-200 py-2.5 rounded-xl font-medium hover:bg-gray-600 transition text-sm">
                            üö™ Cerrar sesi√≥n
                        </button>
                    </div>
                </div>
                
                <!-- Featured Items -->
                <div class="glass-dark rounded-2xl shadow-xl p-6">
                    <div class="flex items-center space-x-2 mb-6">
                        <span class="text-2xl">üåü</span>
                        <h3 class="text-xl font-bold text-white font-serif">Destacados</h3>
                    </div>
                    <div class="space-y-4">
                        <div class="featured-card glass-light pl-4 pr-4 py-4 rounded-xl">
                            <h4 class="font-bold text-white mb-1 font-serif">Toro Trufa</h4>
                            <p class="text-xs text-gray-400 mb-2">At√∫n graso, shiso, aceite de trufa</p>
                            <p class="text-lg font-bold text-gold-500">$229</p>
                        </div>
                        <div class="featured-card glass-light pl-4 pr-4 py-4 rounded-xl">
                            <h4 class="font-bold text-white mb-1 font-serif">Chirashi Bowl</h4>
                            <p class="text-xs text-gray-400 mb-2">Surtido premium de sashimi</p>
                            <p class="text-lg font-bold text-gold-500">$229</p>
                        </div>
                        <div class="featured-card glass-light pl-4 pr-4 py-4 rounded-xl">
                            <h4 class="font-bold text-white mb-1 font-serif">Roll Volc√°n</h4>
                            <p class="text-xs text-gray-400 mb-2">Cangrejo, masago, picante</p>
                            <p class="text-lg font-bold text-red-500">$199</p>
                        </div>
                    </div>
                </div>

                <!-- Info Card -->
                <div class="rounded-2xl shadow-xl p-6 red-gradient text-white">
                    <h3 class="text-xl font-bold mb-4 font-serif">üí° Puedo ayudarte con:</h3>
                    <ul class="space-y-2.5 text-sm">
                        <li class="flex items-start space-x-2">
                            <span class="text-gold-300">‚úì</span>
                            <span>Explicar platillos e ingredientes</span>
                        </li>
                        <li class="flex items-start space-x-2">
                            <span class="text-gold-300">‚úì</span>
                            <span>Opciones sin gluten/veganas</span>
                        </li>
                        <li class="flex items-start space-x-2">
                            <span class="text-gold-300">‚úì</span>
                            <span>Identificar al√©rgenos</span>
                        </li>
                        <li class="flex items-start space-x-2">
                            <span class="text-gold-300">‚úì</span>
                            <span>Ajustar nivel de picante</span>
                        </li>
                        <li class="flex items-start space-x-2">
                            <span class="text-gold-300">‚úì</span>
                            <span>Recomendaciones personalizadas</span>
                        </li>
                    </ul>
                </div>

            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="registerModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-md flex items-center justify-center z-50">
        <div class="glass-dark border-2 border-gold-900/30 rounded-3xl p-8 max-w-md w-full mx-4 shadow-2xl">
            <div class="text-center mb-6">
                <div class="w-16 h-16 gold-gradient rounded-full flex items-center justify-center text-3xl mx-auto mb-4">
                    ‚ú®
                </div>
                <h3 class="text-2xl font-bold mb-2 font-serif text-white">¬°Solo 2 datos!</h3>
                <p class="text-sm text-gray-400">Para personalizar tu experiencia</p>
            </div>
            
            <form id="registerForm" onsubmit="handleRegister(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2 text-gray-300">¬øC√≥mo te llamamos? *</label>
                        <input type="text" id="regName" required class="w-full bg-black/50 border-2 border-gold-900/30 rounded-xl px-4 py-3 text-white focus:bg-black/70" placeholder="Ej: Ana, Carlos">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2 text-gray-300">Tu n√∫mero (WhatsApp) *</label>
                        <input type="tel" id="regPhone" required class="w-full bg-black/50 border-2 border-gold-900/30 rounded-xl px-4 py-3 text-white focus:bg-black/70" placeholder="33 1234 5678">
                        <p class="text-xs text-gray-500 mt-1">Para confirmaciones y ofertas especiales</p>
                    </div>
                    <div id="emailSection" class="hidden">
                        <label class="block text-sm font-semibold mb-2 text-gray-300">Email (opcional)</label>
                        <input type="email" id="regEmail" class="w-full bg-black/50 border-2 border-gold-900/30 rounded-xl px-4 py-3 text-white focus:bg-black/70" placeholder="tu@email.com">
                    </div>
                    <button type="button" onclick="toggleEmail()" class="text-xs text-gold-500 hover:text-gold-400 font-medium">
                        + Agregar email (opcional)
                    </button>
                    <div class="p-3 bg-green-900/20 border border-green-700/30 rounded-xl">
                        <p class="text-xs text-green-400">
                            üîí Tus datos est√°n seguros y protegidos.
                        </p>
                    </div>
                </div>
                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="hideRegister()" class="flex-1 bg-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-600 text-white">
                        Despu√©s
                    </button>
                    <button type="submit" class="flex-1 btn-gold text-black py-3 rounded-xl font-bold hover:shadow-xl transition">
                        ¬°Listo! üéâ
                    </button>
                </div>
                <p class="text-center text-xs text-gray-500 mt-4">
                    Puedes continuar como invitado si prefieres
                </p>
            </form>
        </div>
    </div>

    <script>
        let currentUser = null;
        let conversationHistory = [];
        let detectedPreferences = {
            allergies: [],
            dislikes: [],
            spicyLevel: null,
            dietaryRestrictions: []
        };
        
        // Cargar usuario
        const savedUser = localStorage.getItem('sushiUser');
        if (savedUser) {
            try {
                currentUser = JSON.parse(savedUser);
                currentUser.visits = (currentUser.visits || 1) + 1;
                
                if (currentUser.preferences) {
                    detectedPreferences = {
                        allergies: currentUser.preferences.allergies || [],
                        dislikes: currentUser.preferences.dislikes || [],
                        spicyLevel: currentUser.preferences.spicyLevel || null,
                        dietaryRestrictions: currentUser.preferences.dietaryRestrictions || []
                    };
                }
                
                localStorage.setItem('sushiUser', JSON.stringify(currentUser));
                updateUserUI();
            } catch(e) {}
        }
        
        // Cargar historial
        const savedHistory = localStorage.getItem('conversationHistory');
        if (savedHistory) {
            try {
                conversationHistory = JSON.parse(savedHistory);
            } catch(e) {}
        }
        
        // Mensaje inicial
        setTimeout(() => {
            const greeting = currentUser ? `¬°Bienvenido de nuevo, <strong>${currentUser.name}</strong>!` : '¬°Konnichiwa!';
            addBotMessage(`
                <div class="flex items-start space-x-3">
                    <div class="w-10 h-10 rounded-xl gold-gradient flex items-center justify-center text-xl">üç£</div>
                    <div>
                        <strong class="text-lg text-gold-500">${greeting}</strong> Soy tu asistente de JURELL SUSHI con IA<br><br>
                        ${currentUser ? `<div class="p-2 glass-light rounded-lg mb-2 text-sm border border-gold-900/20"><strong class="text-gold-500">üë§ Tu perfil:</strong><br>‚Ä¢ Visitas: ${currentUser.visits}<br></div>` : ''}
                        <strong class="text-gold-500">üéØ Servicios:</strong> Men√∫, recomendaciones, alergias, ingredientes<br><br>
                        <strong class="text-gold-400">¬°Usa los botones o preg√∫ntame lo que quieras!</strong>
                    </div>
                </div>
            `, false);
        }, 500);
        
        function updateUserUI() {
            if (currentUser) {
                document.getElementById('guestView').classList.add('hidden');
                document.getElementById('userView').classList.remove('hidden');
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('userPhone').textContent = currentUser.phone;
                document.getElementById('userVisits').textContent = currentUser.visits || 1;
                document.getElementById('userFavorite').textContent = currentUser.favoriteDish || 'A√∫n no tienes';
            } else {
                document.getElementById('guestView').classList.remove('hidden');
                document.getElementById('userView').classList.add('hidden');
            }
        }
        
        function showRegister() {
            document.getElementById('registerModal').classList.remove('hidden');
        }
        
        function hideRegister() {
            document.getElementById('registerModal').classList.add('hidden');
        }
        
        function toggleEmail() {
            document.getElementById('emailSection').classList.toggle('hidden');
        }
        
        async function handleRegister(e) {
            e.preventDefault();
            
            const name = document.getElementById('regName').value.trim();
            const phone = document.getElementById('regPhone').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            
            if (!name || !phone) {
                alert('Por favor completa los campos obligatorios');
                return;
            }
            
            currentUser = {
                name: name,
                phone: phone,
                email: email || null,
                registeredAt: new Date().toISOString(),
                visits: 1,
                favoriteDish: null,
                preferences: {
                    allergies: detectedPreferences.allergies || [],
                    dislikes: detectedPreferences.dislikes || [],
                    spicyLevel: detectedPreferences.spicyLevel || 'medium',
                    dietaryRestrictions: detectedPreferences.dietaryRestrictions || []
                }
            };
            
            localStorage.setItem('sushiUser', JSON.stringify(currentUser));
            
            updateUserUI();
            hideRegister();
            
            addBotMessage(`
                <strong class="text-gold-500">üéâ ¬°Perfecto, ${name}!</strong><br><br>
                Ya est√°s registrado. Ahora puedo:<br>
                ‚Ä¢ Recordar tus preferencias y alergias<br>
                ‚Ä¢ Hacer recomendaciones personalizadas<br>
                ‚Ä¢ Guardar tu historial de pedidos<br><br>
                <em class="text-gray-400">¬øQu√© te gustar√≠a ordenar hoy?</em>
            `, false);
            
            document.getElementById('registerForm').reset();
            document.getElementById('emailSection').classList.add('hidden');
        }
        
        function logout() {
            if (confirm('¬øSeguro que quieres cerrar sesi√≥n?')) {
                currentUser = null;
                localStorage.removeItem('sushiUser');
                conversationHistory = [];
                detectedPreferences = {
                    allergies: [],
                    dislikes: [],
                    spicyLevel: null,
                    dietaryRestrictions: []
                };
                localStorage.removeItem('conversationHistory');
                updateUserUI();
                addBotMessage('üëã Sesi√≥n cerrada. Historial y preferencias borrados.', false);
            }
        }
        
        function quickMessage(msg) {
            document.getElementById('chatInput').value = msg;
            sendMessage();
        }
        
        function addUserMessage(text) {
            const container = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = 'flex justify-end chat-bubble';
            div.innerHTML = `<div class="message-user text-white rounded-2xl px-5 py-3 max-w-md shadow-lg">${text}</div>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
        
        function addBotMessage(text, isAI = false) {
            const container = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = 'flex justify-start chat-bubble';
            
            const aiTag = isAI ? '<div class="flex items-center space-x-1 mb-2"><span class="text-xs text-gold-500">ü§ñ AI</span></div>' : '';
            
            div.innerHTML = `<div class="message-bot text-white rounded-2xl px-5 py-3 max-w-md">${aiTag}${text}</div>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
        
        function addThinkingMessage() {
            const container = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.id = 'thinking-message';
            div.className = 'flex justify-start chat-bubble';
            div.innerHTML = `
                <div class="thinking-dots text-gray-300 rounded-2xl px-5 py-3 max-w-md border border-gold-900/20">
                    <div class="flex items-center space-x-2">
                        <div class="w-2 h-2 bg-gold-500 rounded-full animate-bounce"></div>
                        <div class="w-2 h-2 bg-red-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        <div class="w-2 h-2 bg-gold-600 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                        <span class="ml-2">Pensando...</span>
                    </div>
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
        
        function removeThinkingMessage() {
            const thinking = document.getElementById('thinking-message');
            if (thinking) thinking.remove();
        }
        
        function analyzeUserMessage(text) {
            const lower = text.toLowerCase();
            let preferencesChanged = false;
            
            // Detectar alergias
            const allergyPhrases = ['al√©rgico', 'alergia', 'no puedo comer', 'me hace da√±o'];
            if (allergyPhrases.some(phrase => lower.includes(phrase))) {
                const ingredients = ['camar√≥n', 'camaron', 'pescado', 'mariscos', 'gluten', 'lacteos', 'soya', 'huevo', 'nueces', 'sesamo', 'ajonjoli'];
                ingredients.forEach(ing => {
                    if (lower.includes(ing) && !detectedPreferences.allergies.includes(ing)) {
                        detectedPreferences.allergies.push(ing);
                        preferencesChanged = true;
                    }
                });
            }
            
            // Detectar nivel de picante
            if (lower.includes('poco picante') || lower.includes('no picante') || lower.includes('suave')) {
                if (detectedPreferences.spicyLevel !== 'bajo') {
                    detectedPreferences.spicyLevel = 'bajo';
                    preferencesChanged = true;
                }
            } else if (lower.includes('muy picante') || lower.includes('extra picante')) {
                if (detectedPreferences.spicyLevel !== 'alto') {
                    detectedPreferences.spicyLevel = 'alto';
                    preferencesChanged = true;
                }
            }
            
            // Guardar preferencias
            if (currentUser && preferencesChanged) {
                currentUser.preferences = {
                    allergies: detectedPreferences.allergies,
                    dislikes: detectedPreferences.dislikes,
                    spicyLevel: detectedPreferences.spicyLevel,
                    dietaryRestrictions: detectedPreferences.dietaryRestrictions
                };
                localStorage.setItem('sushiUser', JSON.stringify(currentUser));
            }
        }
        
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text) return;
            
            addUserMessage(text);
            input.value = '';
            
            analyzeUserMessage(text);
            addThinkingMessage();
            
            try {
                let userContext = '';
                
                if (currentUser) {
                    userContext = 'PERFIL DEL USUARIO:\n';
                    userContext += '- Nombre: ' + currentUser.name + '\n';
                    userContext += '- Visitas: ' + (currentUser.visits || 1) + '\n';
                }
                
                if (detectedPreferences.allergies.length > 0) {
                    userContext += '\nüö´ ALERGIAS IMPORTANTES:\n';
                    userContext += detectedPreferences.allergies.map(a => '- ' + a.toUpperCase()).join('\n');
                    userContext += '\n‚ö†Ô∏è NUNCA recomiendes platillos con estos ingredientes.\n';
                }
                
                if (detectedPreferences.spicyLevel) {
                    userContext += '\nüå∂Ô∏è Nivel de picante preferido: ' + detectedPreferences.spicyLevel + '\n';
                }
                
                const messages = [];
                const recentHistory = conversationHistory.slice(-10);
                messages.push(...recentHistory);
                messages.push({role: 'user', content: text});
                
                // Llamar al backend (debes crear este endpoint)
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        messages: messages,
                        userContext: userContext
                    })
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Error en la respuesta');
                }
                
                removeThinkingMessage();
                addBotMessage(data.message, true);
                
                conversationHistory.push(
                    {role: 'user', content: text},
                    {role: 'assistant', content: data.message}
                );
                
                if (conversationHistory.length > 20) {
                    conversationHistory = conversationHistory.slice(-20);
                }
                
                localStorage.setItem('conversationHistory', JSON.stringify(conversationHistory));
                
            } catch(error) {
                removeThinkingMessage();
                addBotMessage('‚ö†Ô∏è Error de conexi√≥n. Aseg√∫rate de que el backend est√© configurado. Mensaje: ' + error.message, false);
                console.error('Error:', error);
            }
        }
        
        console.log('üç£ JURELL SUSHI - Chatbot AI Premium');
        console.log('‚úÖ Dise√±o personalizado con paleta del logo');
        console.log('üé® Negro/Dorado/Rojo coral');
        console.log('üîí Backend protegido en Vercel');
    </script>
</body>
</html>
